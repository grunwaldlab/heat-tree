Replace the selectionRect with a shape compatible with both rectangular and circular layouts and able to smoothly transition between the two.
The shape should have arcs on the sides perpendicular to branch extensions (the left/right sides on rectangular layouts and the inner/outer sides for circular layouts) and straignt lines for the sides parallel to the branch extensions (hoirxontal lines for rectangular layouts and radial lines for circular layouts).
The shape should be defined by the coordinates of the 4 corners and lines sshould be drawn as paths, not V/H elements.
Even though arcs are used for the rectangular layouts as well, they should appear straight by choosing a large radius, as is done with the branch offsets, to allow for smooth transitions.

