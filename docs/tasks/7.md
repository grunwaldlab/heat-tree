## Overview

Refactor `src/index.js` from a functional approach to a class-based architecture to support:
- Multiple tree instances
- Dynamic tree/metadata loading and switching
- Better state encapsulation and management
- Easier testing and maintenance


## Implementation Plan


### Phase 1

1. **Create `Subscribable` class** (src/utils.js): extend other classes that need pub/sub mechanics

2. **Create `TreeData` class** (`src/treeData.js`)
 - Extends `Subscribable`
 - Constructor accepts newick string or file path/url and zero or more metadata TSVs as strings or file paths/urls
 - Properties:
   - `metadataTables` - 0 or more parsed datasets named by automatically generated table IDs
   - `enabledTables` - 0 or more currently enabled table IDs that should be attached to tree data
   - `tree` - The parsed tree hierarchy with enabled metadata attached
   - `columnTypes` - The type of each column in any table, such as "continuous" or "categorical", keyed by unique column ID
   - `columnName` - The original name of each column, keyed by unique column ID
   - `columnDisplayName` - The display-friendly name of each column (e.g. capitalization and replacing underscores with spaces), keyed by unique column ID
 - Methods:
   - `parseTree(newickStr)` - parse newick and create hierarchy
   - `setTree(newickStr)` - parse newick str/path and set `tree`. runs `update`
   - `addTable(tableStr, id = null, enable = true, sep = '\t')` - parse metadata string/path and store it. Generate unique column IDs like `table_0_columnName`. Store original column names and display names. Return table ID
   - `deleteTable(tableId)` - remove the specified metadata table and its column mappings. runs `disableTable`
   - `enableTable(tableId)` - specify that this metadata table should be attached to the tree data. runs `update`
   - `disableTable(tableId)` - specify that this metadata table should not be attached to the tree data. runs `update`
   - `attachTables()` - link all enabled metadata to parsed tree nodes using unique column IDs. Each column from each table is stored separately even if they have the same original name
   - `inferTypes()` - infer the column type for all enabled metadata columns using unique column IDs
   - `update()` - attaches enabled tables to tree and notifies subscribers. runs `attachTables` and `inferTypes`
   - `getColumnNames()` - returns array of unique column IDs from enabled tables


### Phase 2

1. Create `ContinuousSizeScale` class (`src/scales.js`)
  - Properties:
    - minimum and maximum value from data
    - The minimum and maximum of the size output
  - Methods:
    - `getValue(int)` - Get the size corresponding to the given values. Clamp at min/max of data values accepted.

2. Create `ContinuousColorScale` class (`src/scales.js`)
  - Properties:
    - minimum and maximum value from data
    - The minimum and maximum of the transformed values between 0 and 1 used to map to the color scale
    - series of colors to interpolate between (at least 1)
    - series of ascending numbers between 0 and 1, one for each color, that defines what color corresponds to what transformed data value. Defaults to equally spaced numbers.
  - Methods:
    - `getValue(int)` - Get the color corresponding to the given values. Clamp at min/max of data values accepted.

3. Create `CategoricalColorScale` class (`src/scales.js`)
  - Properties:
    - The minimum and maximum of the transformed values between 0 and 1 used to map to the color scale
    - Possible categories from data in order of occurance in the dataset
    - A Map of the frequency of values named by categories, in order of descending frequency
    - series of colors to interpolate between (at least 2)
    - series of ascending numbers starting with 0 and ending with 1, one for each color, that defines what color corresponds to what transformed data value. Defaults to equally spaced numbers.
    - A Map of the color assigned to each category
  - Methods:
    - `getValue(int)` - Get the color corresponding to the given values. Clamp at min/max of data values accepted.


### Phase 3

1. **Create `TreeState` class** (`src/treeState.js`): Deals with all states that affect tree appearance at a given size, independent of controls and actual tree display
  - Extends `Subscribable`
  - Constructor accepts initial options
  - Properties:
    - layout
    - label text source metadata
    - label color source metadata
    - label size source metadata
    - label offset
    - displayed root
    - branch length to pixel scaling factor
    - label size to pixel scaling factor
    - target view width and height in pixels
    - required view width and height in pixels
    - label size scale (`ContinuousSizeScale`)
    - label color scale (`ContinuousColorScale` or `CategoricalColorScale`)
    - A copy of the tree hierarchy with the following attached: 
      - which nodes are collapsed subtrees
      - which nodes are collapsed roots
      - the node label
      - the tip label
      - label font
      - label font style (bold, italic, normal)
      - label font size in pixels
      - the branch length in pixels
      - the branch angle in radians
      - the node radius in pixels
      - the node x coordinate in pixels, where the root is at 0
      - the node y coordinate in pixels, where the root is at 0
      - the coordinates of the shape bounding the subtree and its labels
  - Methods:
    - `setLayout(layoutType)` - toggle circular/rectangular
    - `setLabelTextSource(column)` - change label text
    - `setLabelColorSource(column)` - change label coloring
    - `setLabelSizeSource(column)` - change label size
    - `setLabelFontSource(column)` - change label font
    - `setLabelStyleSource(column)` - change label font style
    - `setTargetTreeDimensions(width, hight)` - change the ideal dimensions for the tree
    - `getTreeDimensions()` - get the height and width of the tree when plotted. derived from the shape bounding the root node
    - `updateScaling(factors)` - update scaling factors
    - `collapseSubtree(node)` - collapse a subtree
    - `expandSubtree(node)` - expand a subtree
    - `collapseRoot(node)` - restrict the tree to the node
    - `expandRoot()` - expand the last collapsed root


### Phase 4

1. **Create `TreeRenderer` class** (`src/treeRenderer.js`): Renders all tree-related elements that appear on exported images without controls
 - Constructor accepts container, treeData, treeState, options
 - Methods:
   - `initialize()` - create DOM structure
   - `update(...)` - main update method
   - `updateLegends(...)` - update all legends
   - `destroy()` - cleanup
 - Private helper methods for:
   - Layout calculations
   - Branch rendering
   - Node rendering
   - Label positioning
   - Bounds calculation


### Phase 5

1. **Create `ControlState` class** (`src/controlState.js`): The "backend" and state for UI controls
  - Constructor accepts container, callbacks, options
  - Properties:
    - current transform (effect of pan/zoom)
    - selected node
    - if manual zoom is enabled
    - if manual pan is enabled
    - if automatic zoom is enabled
    - if automatic pan is enabled
  - Methods:
    - `initialize()` - create all controls
    - `updateExpandRootButton(enabled)` - update button state
    - `updateZoomButton(enabled)` - update button state
    - `updateCircularButton(enabled)` - update button state
    - `setTransform(transform)` - update zoom/pan
    - `setSelectedNode(node)` - update selection
    - `toggleZoom()` - toggle zoom enabled
    - `fitToView(transition)` - fit tree to viewport
    - `renderSelection()` - render the selection shape and associated controls
    - `destroy()` - cleanup


### Phase 6

5. **Create `HeatTree` class** (`src/heatTree.js`)
   - Constructor accepts container selector and options
   - Properties:
     - `treeData` - TreeData instance
     - `treeState` - TreeState instance
     - `renderer` - TreeRenderer instance
     - `controls` - TreeControls instance
   - Public methods:
     - `loadTree(newickStr, metadata)` - load new tree data
     - `switchTree(treeData)` - switch to different tree
     - `getState()` - get current state
     - `setState(state)` - restore state
     - `exportSvg()` - export current view
     - `destroy()` - cleanup and remove
   - Private methods:
     - `_initialize()` - setup components
     - `_wireCallbacks()` - connect components


### Phase 7

8. Create `UserInterface` class (`src/userInterface.js`): rendering all of the controls that dont change when trees change
  - Properties:
    - The currently displayed `HeatTree`
    - All available `HeatTree`s


### Phase 8

6. **Update `src/index.js`**
   - Export `HeatTree` class as default
   - Keep `heatTree()` function as wrapper for backwards compatibility
   - Function creates and returns HeatTree instance
